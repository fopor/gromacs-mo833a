---
- hosts: all
  tasks:
    - name: Remove hosts file
      file:
        path: /home/ubuntu/hosts
        state: absent

    - name: Create hosts file
      file:
        path: /home/ubuntu/hosts
        state: touch

    - name: Fetch the keyfile from the node to master
      tags: run
      fetch: 
        src: "~/.ssh/id_rsa.pub"
        dest: "buffer/{{ansible_hostname}}-id_rsa.pub"
        flat: yes    

    - name: Copy the key add to authorized_keys using Ansible module
      tags: runcd
      authorized_key:
        user: ubuntu
        state: present
        key: "{{ lookup('file','buffer/{{item}}-id_rsa.pub')}}"
      when: "{{ item != ansible_hostname }}"
      with_items: 
        - "{{ groups['gromacs'] }}"  

    - name: Add Ansible inventory mappings to /home/ubuntu/hosts
      blockinfile:
        marker: ""
        path: /home/ubuntu/hosts
        block: |
          {% for host in groups['all'] %}
          {{ hostvars[host].ansible_host }} slots=2
          {% endfor %}

    - name: Running simulation across nodes
      shell: "mpirun --hostfile /home/ubuntu/hosts gmx_mpi mdrun -v -deffnm em 1> /home/ubuntu/gmx.out 2> /home/ubuntu/gmx.err"
