---
- hosts: all
  tasks:
  - name: Update packages (works on UBUNTU ONLY!)
    become: yes
    shell: "apt update"

  - name: Installing GROMACS
    become: yes
    shell: "git clone --single-branch --depth=1 --branch ativi-7-exp-1 https://github.com/fopor/gromacs-mo833a.git && chmod 777 gromacs-mo833a/ && cd gromacs-mo833a/experiments/ativ-7-exp-1 && sh build_gromacs.sh"

  - name: Disable hostkey check
    become: yes
    shell: |
      echo 'Host *' > /home/ubuntu/.ssh/config
      echo "  StrictHostKeyChecking no" >> /home/ubuntu/.ssh/config

  - name: Change owner of id_rsa key
    become: yes
    shell: |
      chown ubuntu /home/ubuntu/.ssh/id_rsa

  - name: Remove hosts file
    file:
      path: /home/ubuntu/hosts
      state: absent

  - name: Create hosts file
    file:
      path: /home/ubuntu/hosts
      state: touch

  - name: Fetch the keyfile from the node to master
    tags: run
    fetch: 
      src: "~/.ssh/id_rsa.pub"
      dest: "buffer/{{inventory_hostname}}-id_rsa.pub"
      flat: yes    

  - name: Copy the key add to authorized_keys using Ansible module
    tags: runcd
    authorized_key:
      user: ubuntu
      state: present
      key: "{{ lookup('file','buffer/{{item}}-id_rsa.pub')}}"
    when: "{{ item != ansible_hostname }}"
    with_items: 
      - "{{ groups['all'] }}"  

  - name: Add Ansible inventory mappings to /home/ubuntu/hosts
    blockinfile:
      marker: ""
      path: /home/ubuntu/hosts
      block: |
        {% for host in groups['all'] %}
        {{ hostvars[host].ansible_default_ipv4.address }} slots=1
        {% endfor %}
